#!/bin/bash

# Artis Nova Launcher
# This script starts the backend server and opens the UI.

APP_PATH="$(cd "$(dirname "$0")/../../.." && pwd)"
SERVER_PATH="$APP_PATH/web-control"
LOG_FILE="$APP_PATH/ArtisNova.log"

echo "Starting Artis Nova..." > "$LOG_FILE"

# Check if port 3000 is in use
if lsof -Pi :3000 -sTCP:LISTEN -t >/dev/null ; then
    echo "Port 3000 is busy. Attempting to restart..." >> "$LOG_FILE"
    pkill -f "node $SERVER_PATH/server.js"
    sleep 1
fi

# Start Backend
cd "$SERVER_PATH"
/usr/local/bin/node server.js >> "$LOG_FILE" 2>&1 &
SERVER_PID=$!

echo "Server started with PID $SERVER_PID" >> "$LOG_FILE"

# Wait a moment for server to bind
sleep 2

# Open UI
open "http://localhost:3000"

# Keep the process alive so the app doesn't "quit" immediately
# or wait for the child server
wait $SERVER_PID
