#!/bin/bash
# Artis Nova Launcher
APP_PATH="$(cd "$(dirname "$0")/../../.." && pwd)"
SERVER_PATH="$APP_PATH/web-control"
LOG_FILE="$APP_PATH/ArtisNova.log"

echo "Launcher started at $(date)" > "$LOG_FILE"

# Kill existing node server if any
pkill -f "node $SERVER_PATH/server.js" 2>/dev/null
pkill -9 camilladsp 2>/dev/null

# Create a .command file (this opens in Terminal automatically)
RUN_COMMAND="$APP_PATH/Iniciar Artis Nova.command"
cat <<EOF > "$RUN_COMMAND"
#!/bin/bash
clear
echo "=============================="
echo "    ARTIS NOVA SERVER"
echo "=============================="
# Ir a la carpeta del servidor usando la ruta de este script
cd "\$(dirname "\$0")"
cd web-control
/usr/local/bin/node server.js 2>&1 | tee -a "../ArtisNova.log"
if [ \$? -ne 0 ]; then
    echo ""
    echo "ERROR: El servidor se ha detenido inesperadamente."
    read -p "Presiona Enter para cerrar esta ventana..."
fi
EOF
chmod +x "$RUN_COMMAND"

# Open the server command and UI explicitly with Terminal
open -a Terminal "$RUN_COMMAND"
(sleep 5 && open "http://127.0.0.1:3000") &

exit 0
